class DND{static _id=0;constructor(t=".dnd_el",e){this.id=++DND._id,this._uploadFiles=[],this.dom={$el:null,$elWrap:null,$elInnerTitle:null,$elAlertsWrap:null,$elLoadInput:null,$elLoadInputWrap:null,$loadedImagesWrap:null,$submitForm:null,$submitBtn:null,$fileInput:null,$container:null},this.dom.$container=document.querySelector(t),this._eHandlers={deleteFile:this._deleteFileHandler.bind(this),dragenter:this._dragEnterHandler.bind(this),dragleave:this._dragLeaveHandler.bind(this),dragover:this._dragOverHandler.bind(this),drop:this._dragDropHandler.bind(this),loadFile:this._loadInputHandler.bind(this),submitForm:this._toSubmitFormHandler.bind(this)},this._options={containerSelector:t,actionPath:e.actionPath||"#",multiple:e.multiple||!1,maxFiles:e.maxFiles||2,allowedTypes:e.allowedTypes||"*",theme:e.theme||"light",onlyImage:e.onlyImage||!1,width:e.width||"md",height:e.height||"md",size:e.size||"md",showFileName:!0,submitName:e.submitName||"files",timeShowAlert:e.timeShowAlert||3500,langs:{}},"onlyPhoto"in e&&(this._options.onlyImage=e.onlyPhoto);let i=this._getLangsFromDOM();if(i&&Object.keys(i).length>0){for(let o in i)if(Object.hasOwnProperty.call(i,o)){let s=i[o];this._options.langs[o]=s}}if("customize"in e){for(let l in e.customize)if(Object.hasOwnProperty.call(e.customize,l)){let n=e.customize[l];this._options[l]=n}}if("langs"in e){for(let d in e.langs)if(Object.hasOwnProperty.call(e.langs,d)){let a=e.langs[d];this._options.langs[d]=a}}"showFileName"in e&&(this._options.showFileName=e.showFileName),"size"in e&&(this._options.width=e.width,this._options.height=e.height),"bannedTypes"in e&&(this._options.bannedTypes=e.bannedTypes),"allowedTypes"in e&&"string"==typeof e.allowedTypes&&"*"!=e.allowedTypes&&(this._options.allowedTypes=e.allowedTypes.split(",").map(t=>t.trim())),"bannedTypes"in e&&"string"==typeof e.bannedTypes&&(this._options.bannedTypes=e.bannedTypes.split(",").map(t=>t.trim())),this._addActionPath(t),this.__={saveBtnTxt:this._options.langs.submitBtn||"Сохранить",loadBtnTxt:this._options.langs.loadBtn||`Выберите файл${this._options.multiple?"ы":""}`,title:{default:this._options.langs.titleDefault||`Перетащите файл${this._options.multiple?"ы":""} сюда`,drop:this._options.langs.titleDrop||"Отпустите файл"},alertTxt:{selectPhoto:this._options.langs.selectFileAlert||"Выберите файлы для загрузки"},err:{default:this._options.langs.hasErr||"Произошла ошибка",fileTypeNotAllowed:this._options.langs.onlyPhoto||"Можно загрузить только фото",fileTypeNotSupported:this._options.langs.typeNotSupported||"Формат файла не поддерживается",maxFiles:this._options.langs.maxFiles||"Максимальное к-во элементов: "+this._options.maxFiles,dublicateFile:this._options.langs.reloadFile||"Файл уже загружен"}},this.customFields=this._getCustomFields(),this._init()}_init(){try{if(!this.dom.$container)throw Error("Container element not found");this._addToDOM(),this._initDOMelements(),this._addCustomFields(),this._addEventHandlers()}catch(t){console.error(t.message)}}_addActionPath(t){try{let e=document.querySelector(t);if(!e)throw Error("Container element not found");e.hasAttribute("data-action-path")&&(this._options.actionPath=e.getAttribute("data-action-path"),e.removeAttribute("data-action-path"))}catch(i){console.error(i.message)}}_toSubmitFormHandler(){if(this._uploadFiles.length<=0){this.showAlert(this.__.alertTxt.selectPhoto);return}let t=new DataTransfer,e;for(let i of this._uploadFiles)t.items.add(i);e=t.files,this.dom.$fileInput.files=e,this.dom.$submitForm.submit()}_addToDOM(){this.dom.$container.innerHTML+=this._getHtml()}_getLangsFromDOM(){if(!this.dom.$container)return;let t=this.dom.$container.querySelector(".dnd_langs"),e={};if(t){for(let i of t.children){let o=i.getAttribute("data-to");o&&(e[o]=i.textContent)}return t.remove(),e}}_addCustomFields(){if(this.customFields)for(let t of this.customFields)t.classList.contains("dnd")||this.dom.$submitForm.append(t)}_getCustomFields(){return this.dom.$container.children.length<=0?null:this.dom.$container.children}_addEventHandlers(){this.dom.$elWrap.addEventListener("dragenter",this._eHandlers.dragenter),this.dom.$elWrap.addEventListener("dragleave",this._eHandlers.dragleave),this.dom.$elWrap.addEventListener("dragover",this._eHandlers.dragover),this.dom.$elLoadInput.addEventListener("change",this._eHandlers.loadFile),this.dom.$submitBtn.addEventListener("click",this._eHandlers.submitForm),this.dom.$elWrap.addEventListener("drop",this._eHandlers.drop)}_loadInputHandler(t){this._loadNewFile(t.target.files),this.dom.$elLoadInput.value=""}_deleteFileHandler(t){let e={},i=t.target,o=i.closest(".dnd__upload_file");if(!o)return;let s=(o.querySelector(".dnd__upload_file_title")||e).textContent;s=s?s.trim():"";let l=this._uploadFiles.findIndex(t=>t.name==s);this._uploadFiles.splice(l,1),o.remove(),this.checkEmptyDND()}_dragEnterHandler(t){t.preventDefault(),this.changeState("active")}_dragLeaveHandler(t){t.preventDefault(),this.changeState("default"),this.checkEmptyDND()}_dragOverHandler(t){t.preventDefault(),this.changeState("over")}_dragDropHandler(t){t.preventDefault(),this._loadNewFile(t.dataTransfer.files)}_loadNewFile(t){this.changeState("default"),this._allowedFilter(t),this._multipleValidate(),this._removeDublicateFile(),this._moveFilesToPreview(),this.checkEmptyDND()}_removeDublicateFile(){let t={},e=document.querySelectorAll(".dnd__upload_file");if(this._uploadFiles.length<=0)return!1;this._uploadFiles=this._uploadFiles.filter((i,o,s)=>{if(s.findIndex(e=>(e||t).name===(i||t).name)===o){let l=Array.from(e).find(t=>{let e=t.querySelector(".dnd__upload_file_title").textContent.trim();return e==i.name});return l&&l.remove(),!0}return this.showAlert(this.__.err.dublicateFile),!1})}_moveFilesToPreview(){if(this._uploadFiles.length>0)for(let t=0;t<this._uploadFiles.length;t++){let e=this._uploadFiles[t];if(!e){this._uploadFiles.splice(t,1);return}let i=this._getUploadImg(e);this._addDeleteBtnHandler(i),this.dom.$loadedImagesWrap.append(i)}}_addDeleteBtnHandler(t){if(t){let e=t.querySelector(".dnd__upload_file_delete_btn");e.addEventListener("click",this._eHandlers.deleteFile)}}_getUploadImg(t){if(!(t instanceof File))return;let e=!!t.type.startsWith("image/"),i=URL.createObjectURL(t),o=document.createElement("div");return e||o.setAttribute("data-default",""),o.classList.add("dnd__upload_file"),o.innerHTML=`
      <div class="dnd__upload_file_wrap">
          ${e?`<img src="${i}" alt="upload image">`:""}
          <div class="dnd__upload_file_empty">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 850.149 1045.38"><path d="M685.853 524.23H164.296v-68.266h521.557zm0 173.398H164.296V629.36h521.557zm0 173.853H164.296v-68.266h521.557zM0 21.334h613.08L850.15 258.4v786.933H0zM584.774 89.6H68.267v887.467H781.88V286.71zM850.15 350.378H521.103V21.333h91.978L850.15 258.4zm-260.78-68.266h187.915L589.37 94.197z"/></svg>
          </div>
          <button class="dnd__upload_file_delete_btn" title="удалить">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
                  <path
                      d="m432 32h-120l-9.4-18.7a24 24 0 0 0 -21.5-13.3h-114.3a23.72 23.72 0 0 0 -21.4 13.3l-9.4 18.7h-120a16 16 0 0 0 -16 16v32a16 16 0 0 0 16 16h416a16 16 0 0 0 16-16v-32a16 16 0 0 0 -16-16zm-378.8 435a48 48 0 0 0 47.9 45h245.8a48 48 0 0 0 47.9-45l21.2-339h-384z" />
              </svg>
          </button>
      </div>
      <div class="dnd__upload_file_title">${t.name}</div>
    `,o}_allowedFilter(t){for(let e in t)if(Object.hasOwnProperty.call(t,e)){let i=t[e];this._isAllowedFile(i)&&this._uploadFiles.push(i)}}_isAllowedFile(t){let e=this._checkAllowedFile(t);return!!e.status||(this.showAlert(e.errMsg||this.__.err.default,e.errType),!1)}_initDOMelements(){for(let t in this.dom.$el=this.dom.$container.querySelector(".dnd"),this.dom.$elWrap=this.dom.$container.querySelector(".dnd__wrap"),this.dom.$elLoadInput=this.dom.$container.querySelector(".dnd__file"),this.dom.$elLoadInputWrap=this.dom.$container.querySelector(".dnd__file_wrap"),this.dom.$elInnerTitle=this.dom.$container.querySelector(".dnd__title"),this.dom.$elAlertsWrap=this.dom.$container.querySelector(".dnd__alerts_wrap"),this.dom.$loadedImagesWrap=this.dom.$container.querySelector(".dnd__upload_files"),this.dom.$submitForm=this.dom.$container.querySelector(".dnd__form"),this.dom.$submitBtn=this.dom.$container.querySelector(".dnd__submit_btn"),this.dom.$fileInput=this.dom.$container.querySelector(".dnd__file_input"),this.dom)if(Object.hasOwnProperty.call(this.dom,t)){let e=this.dom[t];if(null===e)throw Error(`required DOM element not found | element: ${t}`)}}_multipleValidate(){if(!this._options.multiple){let t=document.querySelectorAll(".dnd__upload_file"),e=this._uploadFiles[this._uploadFiles.length-1];this._uploadFiles=[e],t&&t.length>0&&t.forEach(t=>t.remove());return}for(;!(this._uploadFiles.length<=this._options.maxFiles);)this.showAlert(this.__.err.maxFiles),this._uploadFiles.pop()}_checkAllowedFile(t){try{if(t instanceof File){if("bannedTypes"in this._options){if(this._options.onlyImage&&!t.type.startsWith("image/"))return{errType:"danger",errMsg:this.__.err.fileTypeNotAllowed,status:!1};let e=t.type.replace(/^image\//,"");if("string"==typeof this._options.bannedTypes){if(e==this._options.bannedTypes)return{errType:"warning",errMsg:this.__.err.fileTypeNotSupported,status:!1}}else if(Array.isArray(this._options.bannedTypes)&&this._options.bannedTypes.includes(e))return{errType:"warning",errMsg:this.__.err.fileTypeNotSupported,status:!1}}if("*"===this._options.allowedTypes){if(this._options.onlyImage&&!t.type.startsWith("image/"))return{errType:"danger",errMsg:this.__.err.fileTypeNotAllowed,status:!1};return{status:!0}}if(Array.isArray(this._options.allowedTypes)){if(this._options.onlyImage&&!t.type.startsWith("image/"))return{errType:"danger",errMsg:this.__.err.fileTypeNotAllowed,status:!1};let i=t.type.replace(/^image\//,"");return this._options.allowedTypes.includes(i)?{status:!0}:{errType:"warning",errMsg:this.__.err.fileTypeNotSupported,status:!1}}}else throw Error("uploaded object is not a file")}catch(o){console.error(o.message)}}_getHtml(){return`
    <div class="dnd"
      data-theme="${this._options.theme}"
      data-width="${this._options.width}"
      data-height="${this._options.height}"
      data-size="${this._options.size}"
    >
        <div class="dnd__wrap">
            <div class="dnd__offer">
                <svg class="dnd__offer_icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path
                        d="m21 16c.5128358 0 .9355072.3860402.9932723.8833789l.0067277.1166211v2c0 1.5976809-1.24892 2.9036609-2.8237272 2.9949073l-.1762728.0050927h-14c-1.59768088 0-2.90366088-1.24892-2.99490731-2.8237272l-.00509269-.1762728v-2c0-.5522847.44771525-1 1-1 .51283584 0 .93550716.3860402.99327227.8833789l.00672773.1166211v2c0 .5128358.38604019.9355072.88337887.9932723l.11662113.0067277h14c.5128358 0 .9355072-.3860402.9932723-.8833789l.0067277-.1166211v-2c0-.5522847.4477153-1 1-1zm-9-14c.5522847 0 1 .44771525 1 1v9.585l1.2928932-1.2921068c.360484-.3604839.927715-.3882135 1.3200062-.0831886l.0942074.0831886c.3604839.360484.3882135.927715.0831886 1.3200062l-.0831886.0942074-3 3-.0439598.0413974-.0678404.0551612-.1112445.0716634-.1127261.0534457-.105343.0353804-.1485188.0290109-.1174742.0068342-.0752385-.0027879-.1254873-.0174522-.1114167-.029498-.111079-.0439353-.0974873-.0523221-.0960413-.0667905c-.0317158-.0248828-.0618904-.0516409-.0903567-.0801072l-2.99999998-3c-.39052429-.3905243-.39052429-1.0236893 0-1.4142136.36048396-.3604839.92771502-.3882135 1.32000622-.0831886l.09420734.0831886 1.29289322 1.2921068v-9.585c0-.55228475.4477153-1 1-1z"
                        fill-rule="evenodd" />
                </svg>
                <div class="dnd__title">${this.__.title.default}</div>
                <span>или</span>
            </div>
            <div class="dnd__file_wrap">
              <label for="dnd__file_${this.id}" class="dnd__file_label">
                <svg class="dnd__file_label_icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 48 48" ><g clip-rule="evenodd" fill="#333" fill-rule="evenodd"><path d="m24 42c9.9411 0 18-8.0589 18-18s-8.0589-18-18-18-18 8.0589-18 18 8.0589 18 18 18zm0 2c11.0457 0 20-8.9543 20-20s-8.9543-20-20-20-20 8.9543-20 20 8.9543 20 20 20z"/><path d="m13 24c0-.5523.4477-1 1-1h20c.5523 0 1 .4477 1 1s-.4477 1-1 1h-20c-.5523 0-1-.4477-1-1z"/><path d="m24 13c.5523 0 1 .4477 1 1v20c0 .5523-.4477 1-1 1s-1-.4477-1-1v-20c0-.5523.4477-1 1-1z"/></g></svg>
                <span>${this.__.loadBtnTxt}</span>
              </label>
              <input class="dnd__file" hidden type="file" id="dnd__file_${this.id}" ${this._options.onlyImage?"accept='image/*'":""} ${this._options.multiple?"multiple":""} />
            </div>

            <div class="dnd__alerts_wrap"></div>
            <div class="dnd__upload_files"></div>
        </div>

        <button hidden class="dnd__submit_btn">${this.__.saveBtnTxt}</button>

        <form hidden class="dnd__form" action="${this._options.actionPath}" method="POST" enctype="multipart/form-data">
            <input type="file" name="${this._options.submitName}${this._options.multiple?"[]":""}" class="dnd__file_input" ${this._options.multiple?"multiple":""} />
        </form>

        <style>
          ${this._options.containerSelector} {
            .dnd {
              ::-webkit-scrollbar {
                ${this._options.dropzoneScroll?"background:"+this._options.dropzoneScroll+";":""};
              }

              ::-webkit-scrollbar-thumb {
                ${this._options.dropzoneScrollThumb?"background:"+this._options.dropzoneScrollThumb+";":""};
              }
            }
            .dnd__wrap {
              ${this._options.dropzone?"background:"+this._options.dropzone+";":""};
              ${this._options.dropzoneBorder?"border-color:"+this._options.dropzoneBorder+";":""};
            }

            .dnd.over .dnd__wrap {
              ${this._options.dropzoneHover?"background:"+this._options.dropzoneHover+";":""};
            }

            .dnd__file_label {
              ${this._options.loadBtn?"background:"+this._options.loadBtn+";":""};
              ${this._options.loadBtnText?"color:"+this._options.loadBtnText+";":""};
              ${this._options.loadBtnBorder?"border-color:"+this._options.loadBtnBorder+";":""};
            }

            .dnd__file_label:hover {
              ${this._options.loadBtnHover?"background:"+this._options.loadBtnHover+";":""};
            }

            .dnd__offer {
              .dnd__offer_icon path {
                ${this._options.dropzoneIcon?"fill:"+this._options.dropzoneIcon+";":""};
              }

              .dnd__title, span {
                ${this._options.dropzoneTitle?"color:"+this._options.dropzoneTitle+";":""};
              }
            }

            .dnd__submit_btn {
              ${this._options.submitBtnText?"color:"+this._options.submitBtnText+";":""};
              ${this._options.submitBtn?"background:"+this._options.submitBtn+";":""};
              ${this._options.submitBtnBorder?"border-color:"+this._options.submitBtnBorder+";":""};
            }

            .dnd__submit_btn:hover {
              ${this._options.submitBtnHover?"background:"+this._options.submitBtnHover+";":""};
            }

            .dnd__file_wrap.compact .dnd__file_label_icon path {
              ${this._options.loadBtnCompact?"fill:"+this._options.loadBtnCompact+";":""};
            }

            .dnd__file_wrap.compact {
              ${this._options.loadBtnCompactBg?"background:"+this._options.loadBtnCompactBg+";":""};
            }

            .dnd__file_wrap.compact .dnd__file_label_icon:hover path {
              ${this._options.loadBtnCompactHover?"fill:"+this._options.loadBtnCompactHover+";":""};
            }

            .dnd__upload_file[data-default] .dnd__upload_file_wrap {
              ${this._options.defaultPreview?"background:"+this._options.defaultPreview+";":""};
              ${this._options.defaultPreviewBorder?"border-color:"+this._options.defaultPreviewBorder+";":""};
            }

            .dnd__upload_file[data-default] .dnd__upload_file_empty path {
              ${this._options.defaultPreviewIcon?"fill:"+this._options.defaultPreviewIcon+";":""};
            }

            .dnd__upload_file_title {
              ${this._options.previewFileName?"color:"+this._options.previewFileName+";":""};
            }

            .dnd__upload_file_title {
              ${this._options.showFileName?"display: block;":"display: none;"};
            }

            .dnd__upload_file_delete_btn svg path {
              ${this._options.previewDeleteBtn?"fill:"+this._options.previewDeleteBtn+";":""};
            }

            .dnd__upload_file_delete_btn svg:hover path {
              ${this._options.previewDeleteBtnHover?"fill:"+this._options.previewDeleteBtnHover+";":""};
            }

            .dnd__alert[data-type="warning"] {
              ${this._options.alertWarningBg?"background:"+this._options.alertWarningBg+";":""};
              ${this._options.alertWarningText?"color:"+this._options.alertWarningText+";":""};
              ${this._options.alertWarningBorder?"border-color:"+this._options.alertWarningBorder+";":""};
            }

            .dnd__alert[data-type="danger"] {
              ${this._options.alertDangerBg?"background:"+this._options.alertDangerBg+";":""};
              ${this._options.alertDangerText?"color:"+this._options.alertDangerText+";":""};
              ${this._options.alertDangerBorder?"border-color:"+this._options.alertDangerBorder+";":""};
            }

            @media (pointer:coarse) {
              .dnd__upload_file_delete_btn::after,
              .dnd__upload_file_delete_btn::before {
                ${this._options.previewDeleteBtnCompact?"background:"+this._options.previewDeleteBtnCompact+";":""};
              }
            }
          }
        </style>
    </div>
    `}changeTitle(t=this.__.title.default){this.dom.$elInnerTitle.textContent=t}showAlert(t="",e="warning",i=this._options.timeShowAlert){let o=document.querySelectorAll(".dnd__alert");if(o){for(let s of o)if(s.textContent==t&&s.getAttribute("data-type")==e)return}let l=document.createElement("div");l.setAttribute("data-type",e),l.classList.add("dnd__alert"),l.textContent=t,this.dom.$elAlertsWrap.append(l),setTimeout(()=>l.remove(),i)}changeState(t){switch(t){case"active":this.changeTitle(this.__.title.drop),this.dom.$el.classList.add("active");break;case"filled":this.dom.$el.classList.add("filled");break;case"over":this.changeTitle(this.__.title.drop),this.dom.$el.classList.add("over");break;default:this.changeTitle(this.__.title.default),this.dom.$el.classList.remove("active"),this.dom.$el.classList.remove("filled"),this.dom.$el.classList.remove("over")}}showSubmitBtn(){this.dom.$submitBtn.removeAttribute("hidden")}hiddenSubmitBtn(){this.dom.$submitBtn.setAttribute("hidden","")}checkEmptyDND(){this._uploadFiles.length>0?(this.changeState("filled"),this.showSubmitBtn(),this._options.multiple&&this._uploadFiles.length<this._options.maxFiles?(this.dom.$elLoadInputWrap.classList.add("compact"),this.dom.$elLoadInputWrap.removeAttribute("hidden")):(this.dom.$elLoadInputWrap.classList.remove("compact"),this.dom.$elLoadInputWrap.setAttribute("hidden",""))):(this.dom.$elLoadInputWrap.classList.remove("compact"),this.dom.$elLoadInputWrap.removeAttribute("hidden"),this.changeState("default"),this.hiddenSubmitBtn())}}